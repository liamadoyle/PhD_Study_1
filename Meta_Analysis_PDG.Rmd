---
title: "Meta-Analysis (pdg)"
author: "Liam A. Doyle"
date: "2024-07-05"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(meta)
library(metafor)
library(devtools)
library(esc)
library(effectsize)
library(psych)
library(dmetar)
library(readxl)
```

```{r import, include=FALSE}
PDG <- read_excel("PDG.xlsx")
```

```{r recode, include=FALSE}
PDG$Sample_Source <- factor(PDG$Sample_Source,
                                  levels = c(0, 1, 2, 3),
                                  labels = c("Community", "Student", "Inmate", "Mixed"))

PDG$Publication_Status <- factor(PDG$Publication_Status,
                                       levels = c(0, 1),
                                       labels = c("Unpublished", "Published"))

PDG$Measure_coded <- factor(PDG$Measure_coded,
                                       levels = c(0, 1, 2, 3, 4, 5, 6),
                                       labels = c("SRP", "PCL", "PPI", 
                                                  "LSRP", "TriPM", "SD3",
                                                  "DD"))

PDG$Iterated <- factor(PDG$Iterated,
                                       levels = c(0, 1),
                                       labels = c("One-shot", "Iterated"))

PDG$Perceived_Opponent <- factor(PDG$Perceived_Opponent,
                                 levels = c(0, 1),
                                 labels = c("No", "Yes"))

PDG$Social_role <- factor(PDG$Social_role,
                                       levels = c(0, 1),
                                       labels = c("Close member", "Distant member"))

PDG$Incentives <- factor(PDG$Incentives,
                               levels = c(0, 1, 2),
                               labels = c("Not incentivized", "Participation incentivized",
                                          "Performance incentivized"))

PDG$Experimental_Manipulation <- factor(PDG$Experimental_Manipulation,
                                        levels = c(0, 1),
                                        labels = c("No manipulation", 
                                                   "Manipulation"))

PDG$Feedback <- factor(PDG$Feedback,
                             levels = c(0, 1),
                             labels = c("No feedback", "Feedback"))

PDG$Strategy <- factor(PDG$Strategy,
                             levels = c(0, 1, 2, 3, 4, 5),
                             labels = c("Live opponent", "TFT", "TF2T",
                                        "Neutral/Seesaw", "Random",
                                        "Replicator"))

PDG$Leniency <- factor(PDG$Leniency,
                             levels = c(0, 1, 2),
                             labels = c("Lenient", "Neutral", "Harsh"))
```

```{r transform, include=FALSE}
# PDG <- PDG %>%
  # mutate(z_psyc_coop = 0.5 * log((1 + Psych_Coop)/(1 - Psych_Coop)))

# PDG <- PDG %>%
  # mutate(z_se_psyc_coop = 1/(sqrt(n_effect - 3)))

# PDG <- PDG %>%
  # mutate(var_z_psyc_coop = (z_se_psyc_coop^2))

# PDG <- PDG %>%
  # mutate(z_psyc_succ = 0.5 * log((1 + Psychopathy_Succ)/(1 - Psychopathy_Succ)))

# PDG <- PDG %>%
    # mutate(z_se_psyc_succ = (z_psyc_succ > 0), 1/(sqrt(n_effect - 3)))
```

## Project Description

This is an R Markdown file that documents for some of the analyses conducted for the first study in my dissertation. Specifically, this file documents the multi-level meta-analytic model conducted for the effect of psychopathy on behaviour in the Prisoner's Dilemma Game (PDG).

## Simple Random Effects Model of Psychopathy on Success in the PDG

```{r success, echo=FALSE, warning=FALSE}
PDG.remove.na <- drop_na(PDG, Psychopathy_Succ)

psyc.success <- metacor(cor = Psychopathy_Succ, 
                 n = n_effect,
                 studlab = Study,
                 data = PDG.remove.na,
                 fixed = FALSE,
                 random = TRUE,
                 method.tau = "REML",
                 method.random.ci = "HK",
                 title = "Psychopathy and Success in the PDG")

summary(psyc.success)
```

## Forest Plot of Psychopathy-Success Meta-Analysis

```{r forest success, echo=FALSE, warning=FALSE}
forestplot <- meta::forest(psyc.success,
                           sortvar = Psychopathy_Succ,
                           prediction = TRUE,
                           print.tau2 = TRUE)
```
## Drapery Plot of Psychopathy-Success Meta-Analysis

```{r drapery success, echo=FALSE, warning=FALSE}
drapery(psyc.success,
        labels = "studlab",
        type = "pval",
        legend = TRUE)
```

## Funnel Plot of Psychopathy-Cooperation Meta-Analysis

```{r funnel success, echo=FALSE, warning=FALSE}
meta::funnel(psyc.success,
             xlim = c(-1, 1),
             studlab = FALSE)

title("Funnel Plot of the Effect Sizes for the Psychopathy-Success Relationship")
```

## Egger's Regression Test

```{r egger success, echo=FALSE, warning=FALSE}
metabias(psyc.success,
         method.bias = "linreg",
         k.min = 5)
```

## Fail-Safe *N*

```{r fail-safe success, echo=FALSE, warning=FALSE}
fail.safe <- rma(yi = z_psyc_succ,
                 vi = var_z_psyc_succ,
                 slab = Study,
                 data = PDG,
                 test = "t",
                 method = "REML")

fsn(fail.safe, type = "General", target = 0.05)
```


## Sensitivity Analysis Omitting Testori (2019b)

```{r sensitivity success, echo=FALSE, warning=FALSE}
omit.testori2019b <- PDG.remove.na[-c(7), ]

psyc.success.omit <- metacor(cor = Psychopathy_Succ, 
                        n = n_effect,
                        studlab = Study,
                        data = omit.testori2019b,
                        fixed = FALSE,
                        random = TRUE,
                        method.tau = "REML",
                        method.random.ci = "HK",
                        title = "Psychopathy and Success in the PDG")

summary(psyc.success.omit)
```

## Multi-Level Random Effects Model of Psychopathy on Cooperation in the PDG

```{r model, echo=FALSE, warning=FALSE}
full.model <- rma.mv(yi = z_psyc_coop,
                     V = var_z_psyc_coop,
                     slab = Study,
                     data = PDG,
                     random = ~ 1 | Study/Effect_size_ID,
                     test = "t",
                     method = "REML")

summary(full.model)

convert_z2r(-.1578)
```
## Distribution of Variance Across Levels

```{r variance, echo=FALSE, warning=FALSE}
i2 <- var.comp(full.model)

plot(i2)
```


## Comparing Models

Examining the fit of the simple random-effects meta-analytic model vs. the multi-level random-effects meta-analytic model.

```{r model comparison, echo=FALSE, warning=FALSE}
l3.removed <- rma.mv(yi = z_psyc_coop,
                     V = var_z_psyc_coop,
                     slab = Study,
                     data = PDG,
                     random = ~ 1 | Study/Effect_size_ID,
                     test = "t",
                     method = "REML",
                     sigma2 = c(0, NA))

anova(full.model, l3.removed)
```

## Forest Plot of Psychopathy-Cooperation Meta-Analysis

Note: This plot had to be generated using a simple random-effects meta-analytic model, as there is not a package available in *R* to accommodate the creation of forest plots for multi-level meta-analytic models.

```{r forest plot, echo=FALSE, warning=FALSE}
m.cor <- metacor(cor = Psych_Coop,
                 n = n_effect,
                 studlab = Study,
                 data = PDG,
                 fixed = FALSE,
                 random = TRUE,
                 method.tau = "REML",
                 method.random.ci = "HK",
                 title = "Psychopathy and Cooperation in the PDG")

forestplot <- meta::forest(m.cor,
                           sortvar = Psych_Coop,
                           prediction = TRUE,
                           print.tau2 = TRUE,
                           file = "forest.jpeg",
                           width = 1000)

knitr::include_graphics("forest.jpeg")
```

## Drapery Plot of Psychopathy-Cooperation Meta-Analysis

```{r drapery plot, echo=FALSE, warning=FALSE}
drapery(m.cor,
        labels = "studlab",
        type = "pval",
        srt.labels = 45,
        legend = TRUE)
```

## Funnel Plot of Psychopathy-Cooperation Meta-Analysis

```{r funnel plot, echo=FALSE, warning=FALSE}
meta::funnel(m.cor,
             xlim = c(-1, 1),
             studlab = FALSE)

title("Funnel Plot of the Effect Sizes for the Psychopathy-Cooperation Relationship")
```

## Egger's Regression Test

```{r egger, echo=FALSE, warning=FALSE}
metabias(m.cor,
         method.bias = "linreg")
```

## Fail-Safe *N*

```{r fail-safe, echo=FALSE, warning=FALSE}
fail.safe <- rma(yi = z_psyc_coop,
                 vi = var_z_psyc_coop,
                 slab = Study,
                 data = PDG,
                 test = "t",
                 method = "REML")

fsn(fail.safe, type = "General", target = 0.05)
```

## *N* as a Moderator of Effect Size

```{r moderator n, echo=FALSE, warning=FALSE}
mod.model.n <- rma.mv(yi = z_psyc_coop,
                    V = var_z_psyc_coop,
                    slab = Study,
                    data = PDG,
                    random = ~ 1 | Study/Effect_size_ID,
                    test = "t",
                    method = "REML",
                    mods = ~ n_effect)

summary(mod.model.n)
```

## Sex Composition as a Moderator of Effect Size

```{r moderator sex, echo=FALSE, warning=FALSE}
mod.model.sex <- rma.mv(yi = z_psyc_coop,
                             V = var_z_psyc_coop,
                             slab = Study,
                             data = PDG,
                             random = ~ 1 | Study/Effect_size_ID,
                             test = "t",
                             method = "REML",
                             mods = ~ Sex_female)

summary(mod.model.sex)
```

## Average Sample Age as a Moderator of Effect Size

```{r moderator age, echo=FALSE, warning=FALSE}
mod.model.age <- rma.mv(yi = z_psyc_coop,
                        V = var_z_psyc_coop,
                        slab = Study,
                        data = PDG,
                        random = ~ 1 | Study/Effect_size_ID,
                        test = "t",
                        method = "REML",
                        mods = ~ Age)

summary(mod.model.age)
```

## Sample Source as a Moderator of Effect Size

```{r moderator sample, echo=FALSE, warning=FALSE}
mod.model.sample <- rma.mv(yi = z_psyc_coop,
                        V = var_z_psyc_coop,
                        slab = Study,
                        data = PDG,
                        random = ~ 1 | Study/Effect_size_ID,
                        test = "t",
                        method = "REML",
                        mods = ~ Sample_Source)

summary(mod.model.sample)
```

## Publication Status as a Moderator of Effect Size

```{r moderator publication, echo=FALSE, warning=FALSE}
mod.model.pub <- rma.mv(yi = z_psyc_coop,
                           V = var_z_psyc_coop,
                           slab = Study,
                           data = PDG,
                           random = ~ 1 | Study/Effect_size_ID,
                           test = "t",
                           method = "REML",
                           mods = ~ Publication_Status)

summary(mod.model.pub)
```

## Psychopathy Measure as a Moderator of Effect Size

```{r moderator measure, echo=FALSE, warning=FALSE}
mod.model.measure <- rma.mv(yi = z_psyc_coop,
                        V = var_z_psyc_coop,
                        slab = Study,
                        data = PDG,
                        random = ~ 1 | Study/Effect_size_ID,
                        test = "t",
                        method = "REML",
                        mods = ~ Measure_coded)

summary(mod.model.measure)
```

## One-Shot vs. Iterated as a Moderator of Effect Size

```{r moderator iterated, echo=FALSE, warning=FALSE}
mod.model.iterated <- rma.mv(yi = z_psyc_coop,
                            V = var_z_psyc_coop,
                            slab = Study,
                            data = PDG,
                            random = ~ 1 | Study/Effect_size_ID,
                            test = "t",
                            method = "REML",
                            mods = ~ Iterated)

summary(mod.model.iterated)
```

## Perceived Opponent as a Moderator of Effect Size

```{r moderator perceived, echo=FALSE, warning=FALSE}
mod.model.perceive <- rma.mv(yi = z_psyc_coop,
                             V = var_z_psyc_coop,
                             slab = Study,
                             data = PDG,
                             random = ~ 1 | Study/Effect_size_ID,
                             test = "t",
                             method = "REML",
                             mods = ~ Perceived_Opponent)

summary(mod.model.perceive)
```

## Social Role as a Moderator of Effect Size

```{r moderator social role, echo=FALSE, warning=FALSE}
mod.model.social <- rma.mv(yi = z_psyc_coop,
                             V = var_z_psyc_coop,
                             slab = Study,
                             data = PDG,
                             random = ~ 1 | Study/Effect_size_ID,
                             test = "t",
                             method = "REML",
                             mods = ~ Social_role)

summary(mod.model.social)
```

## Incentive Structure as a Moderator of Effect Size

```{r moderator incentive, echo=FALSE, warning=FALSE}
mod.model.incentive <- rma.mv(yi = z_psyc_coop,
                           V = var_z_psyc_coop,
                           slab = Study,
                           data = PDG,
                           random = ~ 1 | Study/Effect_size_ID,
                           test = "t",
                           method = "REML",
                           mods = ~ Incentives)

summary(mod.model.incentive)
```

## *k*-Index as a Moderator of Effect Size

```{r moderator k, echo=FALSE, warning=FALSE}
mod.model.k <- rma.mv(yi = z_psyc_coop,
                              V = var_z_psyc_coop,
                              slab = Study,
                              data = PDG,
                              random = ~ 1 | Study/Effect_size_ID,
                              test = "t",
                              method = "REML",
                              mods = ~ K)

summary(mod.model.k)
```

## Feedback as a Moderator of Effect Size

```{r moderator feedback, echo=FALSE, warning=FALSE}
mod.model.feedback <- rma.mv(yi = z_psyc_coop,
                      V = var_z_psyc_coop,
                      slab = Study,
                      data = PDG,
                      random = ~ 1 | Study/Effect_size_ID,
                      test = "t",
                      method = "REML",
                      mods = ~ Feedback)

summary(mod.model.feedback)
```

## Strategy as a Moderator of Effect Size

```{r moderator strategy, echo=FALSE, warning=FALSE}
mod.model.strategy <- rma.mv(yi = z_psyc_coop,
                             V = var_z_psyc_coop,
                             slab = Study,
                             data = PDG,
                             random = ~ 1 | Study/Effect_size_ID,
                             test = "t",
                             method = "REML",
                             mods = ~ Strategy)

summary(mod.model.strategy)
```

## Opponent Leniency as a Moderator of Effect Size

```{r moderator leniency, echo=FALSE, warning=FALSE}
mod.model.leniency <- rma.mv(yi = z_psyc_coop,
                             V = var_z_psyc_coop,
                             slab = Study,
                             data = PDG,
                             random = ~ 1 | Study/Effect_size_ID,
                             test = "t",
                             method = "REML",
                             mods = ~ Leniency)

summary(mod.model.leniency)

```
